<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="뒤태지존의 끄적거림">
    <title>Kafka Poison Pill Spring ErrorHandlingDeserializer - 뒤태지존의 끄적거림</title>
    <meta name="author" content="HomoEfficio">
    <meta name="description" content="뒤태지존의 끄적거림">
    
        <link rel="icon" href="/assets/images/favicon.ico">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Kafka Poison Pill Spring ErrorHandlingDeserializer카프카 메시지 consume은 대략 다음과 같은 절차로 진행된다.  Fetch Serialized Data from Broker(직렬화된 데이터를 브로커로부터 가져와서) Deserialize the fetched serialized data(정해진 타입으로 역직렬화하고">
<meta name="keywords" content="Spring,Kafka,Consumer,Deserializer,Poison Pill,ErrorHandlingDeserializer">
<meta property="og:type" content="blog">
<meta property="og:title" content="Kafka Poison Pill Spring ErrorHandlingDeserializer">
<meta property="og:url" content="http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/index.html">
<meta property="og:site_name" content="뒤태지존의 끄적거림">
<meta property="og:description" content="Kafka Poison Pill Spring ErrorHandlingDeserializer카프카 메시지 consume은 대략 다음과 같은 절차로 진행된다.  Fetch Serialized Data from Broker(직렬화된 데이터를 브로커로부터 가져와서) Deserialize the fetched serialized data(정해진 타입으로 역직렬화하고">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https://i.imgur.com/ly5PPnv.png">
<meta property="og:updated_time" content="2022-08-27T16:44:23.303Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kafka Poison Pill Spring ErrorHandlingDeserializer">
<meta name="twitter:description" content="Kafka Poison Pill Spring ErrorHandlingDeserializer카프카 메시지 consume은 대략 다음과 같은 절차로 진행된다.  Fetch Serialized Data from Broker(직렬화된 데이터를 브로커로부터 가져와서) Deserialize the fetched serialized data(정해진 타입으로 역직렬화하고">
<meta name="twitter:image" content="https://i.imgur.com/ly5PPnv.png">
    
        <meta rel="publisher" content="https://plus.google.com/+오명운"/>
    
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=640"/>
    
    
        <meta property="og:image" content="/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/https:/i.imgur.com/jLyUOib.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/https://i.imgur.com/jLyUOib.jpg" />
    
    
        <meta property="og:image" content="/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/cover-kafka-poison-pill.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/cover-kafka-poison-pill.png" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-79893978-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6494847158566766",
    enable_page_level_ads: true
  });
</script>
</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">뒤태지존의 끄적거림</a>
    </h1>
    
        <a class="header-right-picture" href="/#about">
            <img class="header-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=90"/>
        </a>
    
</header>
            <nav id="sidebar" data-behavior="1">
    
    <div class="sidebar-profile">
        <a href="/#about">
            
            <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=90"/>
            
        </a>
        <span class="sidebar-profile-name">HomoEfficio</span>
    </div>
    
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/ 
                    ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-categories
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-tags
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-archives
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link st-search-show-outputs"
                    href="#search
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="#about
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About me</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://github.com/HomoEfficio" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="mailto:homo.efficio@gmail.com" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/atom.xml
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>
            <div id="main" data-behavior="1">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
        <div class="post-header-cover" style="background-image:url('/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/cover-kafka-poison-pill.png');">
            <div class="post-header main-content-wrap">
    
        <h1 class="post-title" itemprop="headline">Kafka Poison Pill Spring ErrorHandlingDeserializer</h1>
    
    <div class="post-meta">
    <time  itemprop="datePublished" content="Sun Aug 28 2022 01:19:22 GMT+0900">
        Aug 28, 2022
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Technique/">Technique</a>


    
</div>
</div>
        </div>
    
    <div class="post-content markdown main-content-wrap" itemprop="articleBody">
        
            <h1 id="Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer"><a href="#Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer" class="headerlink" title="Kafka Poison Pill Spring ErrorHandlingDeserializer"></a>Kafka Poison Pill Spring ErrorHandlingDeserializer</h1><p>카프카 메시지 consume은 대략 다음과 같은 절차로 진행된다.</p>
<ol>
<li>Fetch Serialized Data from Broker(직렬화된 데이터를 브로커로부터 가져와서)</li>
<li>Deserialize the fetched serialized data(정해진 타입으로 역직렬화하고)</li>
<li>Consume the deserialized data(역직렬화한 데이터를 처리하고)</li>
<li>Commit(브로커에게 commit 신호 전송)</li>
</ol>
<h2 id="받아온-메시지-처리에-실패하면"><a href="#받아온-메시지-처리에-실패하면" class="headerlink" title="받아온 메시지 처리에 실패하면.."></a>받아온 메시지 처리에 실패하면..</h2><p>스프링 카프카를 사용하면서 개발자가 @KafkaListener를 붙여 작성한 리스너 구현부는 3번 과정에 해당한다.<br>3번 과정에서 에러가 발생하면 정해진 횟수(기본 10회)만큼 재시도 후 끝까지 실패하면 대략 아래와 같은 에러 로그를 남기면서 그냥 4번 commit 신호를 브로커로 보낸다.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">2022-08-27 22:50:06.326 ERROR 64718 --- [ntainer#0-0-C-1] o.s.kafka.listener.DefaultErrorHandler   : Backoff FixedBackOff&#123;interval=0, currentAttempts=10, maxAttempts=9&#125; exhausted for basic-topic-01-1@2</span><br><span class="line"></span><br><span class="line">org.springframework.kafka.listener.ListenerExecutionFailedException: Listener method &apos;public void io.homo_efficio.scratchpad.spring.reactor.kafka.service.KafkaConsumer.listenerBasicTopic01(java.lang.String)&apos; threw exception; nested exception is java.lang.RuntimeException: 4th 메시지는 처리 불가!!!; nested exception is java.lang.RuntimeException: 4th 메시지는 처리 불가!!!</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.decorateException(KafkaMessageListenerContainer.java:2703) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeOnMessage(KafkaMessageListenerContainer.java:2673) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeOnMessage(KafkaMessageListenerContainer.java:2633) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeRecordListener(KafkaMessageListenerContainer.java:2560) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeWithRecords(KafkaMessageListenerContainer.java:2441) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeRecordListener(KafkaMessageListenerContainer.java:2319) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeListener(KafkaMessageListenerContainer.java:1990) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeIfHaveRecords(KafkaMessageListenerContainer.java:1366) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.pollAndInvoke(KafkaMessageListenerContainer.java:1357) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:1252) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) ~[na:na]</span><br><span class="line">    at java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:264) ~[na:na]</span><br><span class="line">    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java) ~[na:na]</span><br><span class="line">    at java.base/java.lang.Thread.run(Thread.java:832) ~[na:na]</span><br><span class="line">    Suppressed: org.springframework.kafka.listener.ListenerExecutionFailedException: Restored Stack Trace</span><br><span class="line">        at org.springframework.kafka.listener.adapter.MessagingMessageListenerAdapter.invokeHandler(MessagingMessageListenerAdapter.java:363) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">        at org.springframework.kafka.listener.adapter.RecordMessagingMessageListenerAdapter.onMessage(RecordMessagingMessageListenerAdapter.java:92) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">        at org.springframework.kafka.listener.adapter.RecordMessagingMessageListenerAdapter.onMessage(RecordMessagingMessageListenerAdapter.java:53) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeOnMessage(KafkaMessageListenerContainer.java:2653) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">Caused by: java.lang.RuntimeException: 4th 메시지는 처리 불가!!!</span><br><span class="line">    at io.homo_efficio.scratchpad.spring.reactor.kafka.service.KafkaConsumer.listenerBasicTopic01(KafkaConsumer.kt:13) ~[main/:na]</span><br><span class="line">    at jdk.internal.reflect.GeneratedMethodAccessor85.invoke(Unknown Source) ~[na:na]</span><br><span class="line">    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]</span><br><span class="line">    at java.base/java.lang.reflect.Method.invoke(Method.java:564) ~[na:na]</span><br><span class="line">    at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:169) ~[spring-messaging-5.3.21.jar:5.3.21]</span><br><span class="line">    at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:119) ~[spring-messaging-5.3.21.jar:5.3.21]</span><br><span class="line">    at org.springframework.kafka.listener.adapter.HandlerAdapter.invoke(HandlerAdapter.java:56) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.adapter.MessagingMessageListenerAdapter.invokeHandler(MessagingMessageListenerAdapter.java:347) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.adapter.RecordMessagingMessageListenerAdapter.onMessage(RecordMessagingMessageListenerAdapter.java:92) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.adapter.RecordMessagingMessageListenerAdapter.onMessage(RecordMessagingMessageListenerAdapter.java:53) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeOnMessage(KafkaMessageListenerContainer.java:2653) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    ... 12 common frames omitted</span><br></pre></td></tr></table></figure>
<p>브로커는 commit 신호를 받아서 해당 토픽, 파티션의 offset을 증가시킨다.<br>컨수머 입장에서는 해당 데이터 처리에 실패했지만, 브로커 입장에서는 정상적으로 데이터가 처리됐을 때와 마찬가지로 commit 신호를 받으므로 장애는 발생하지 않는다.</p>
<h2 id="역직렬화에-실패하면"><a href="#역직렬화에-실패하면" class="headerlink" title="역직렬화에 실패하면.."></a>역직렬화에 실패하면..</h2><p>그런데 2번 역직렬화 과정에서 에러가 나면 어떻게 될까?</p>
<p>예를 들어 JsonSerializer/JsonDeserializer를 사용해서 JSON으로 직렬화/역직렬화하도록 구성했는데,<br>JSON 규격에 맞지 않는 메시지(poison pill)가 인입되면 역직렬화 과정에서 에러가 발생하게 된다.</p>
<p>2번 <strong>역직렬화 과정은 3번 과정보다 앞서 진행되므로 2번 과정에서 에러가 발생하면 개발자가 작성한 리스너로 진입하지 못하며,</strong><br>그 앞 단계에서 즉 프레임워크 수준에서 에러 처리가 돼야 한다.<br>그런데 이 에러 처리를 별로 신경쓰지 않고 사용하다가 역직렬화 과정에서 에러가 발생하면,<br>3번 과정에서 처럼 정해진 횟수만큼 재시도하다가 얌전히 포기하고 commit 처리되는 게 아니라,<br><strong>역직렬화에 성공할 때까지 계속, 그것도 아주 빠른 속도로 재시도한다.</strong></p>
<p>그런데 역직렬화 실패한 데이터를 다시 역직렬화 하면 성공할 수 있을까?<br>그럴 가능성은 거의 없다고 생각하는데 안타깝게도 카프카 컨수머는, 아니 최소한 <strong>카프카 스프링 컨수머는 역직렬화 안 되면 될 때까지, 서버 빠개질때까지!! 그렇게 무식하게 동작한다.</strong></p>
<p><img src="https://i.imgur.com/ly5PPnv.png" alt="Imgur"></p>
<p>그 결과 컨수머 시스템 자원이 갉아먹히는데,<br><strong>이 컨수머가 다른 토픽의 컨수머이기도 하면 자원 부족으로 그 다른 토픽의 메시지를 컨숨하는 속도가 느려지고 그 다른 토픽에도 메시지가 쌓이게 된다.</strong><br><strong>결국 이 컨수머를 포함하고 있는 서버 인스턴스들은 점점 좀비화되고 서비스 장애 상황으로 이어진다.</strong></p>
<p>그러니 역직렬화에 실패하면,<br>마치 혁명에 실패하면 반역죄로 능지처사에 3족이 멸문 당하는 것처럼 아주 걍 작살이 나는 거시다.</p>
<h2 id="Spring-ErrorHandlingDeserializer"><a href="#Spring-ErrorHandlingDeserializer" class="headerlink" title="Spring ErrorHandlingDeserializer"></a>Spring ErrorHandlingDeserializer</h2><p>위에 ‘(역직렬화 과정) 에러 처리를 별로 신경쓰지 않고 기본 설정으로 두고 사용하면’이라는 단서가 있는데,<br>바꿔말하면 역직렬화 에러 처리를 신경쓰면 위와 같은 장애 발생을 막을 수 있다. 어떻게?</p>
<p><strong>스프링 카프카 2.2에 도입된 ErrorHandlingDeserializer를 사용하고, ErrorHandler를 지정해주면 된다.</strong></p>
<p>이 내용은 역직렬화 재시도를 계속하면서 펑펑 싸대는 아래와 같은 로그에 나름 친절하게 나와있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">2022-08-27 14:03:22.077 ERROR 81052 --- [ntainer#0-0-C-1] o.s.k.l.KafkaMessageListenerContainer    : Consumer exception</span><br><span class="line"></span><br><span class="line">java.lang.IllegalStateException: This error handler cannot process &apos;SerializationException&apos;s directly; please consider configuring an &apos;ErrorHandlingDeserializer&apos; in the value and/or key deserializer</span><br><span class="line">    at org.springframework.kafka.listener.DefaultErrorHandler.handleOtherException(DefaultErrorHandler.java:149) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.handleConsumerException(KafkaMessageListenerContainer.java:1799) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:1298) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) ~[na:na]</span><br><span class="line">    at java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:264) ~[na:na]</span><br><span class="line">    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java) ~[na:na]</span><br><span class="line">    at java.base/java.lang.Thread.run(Thread.java:832) ~[na:na]</span><br><span class="line">Caused by: org.apache.kafka.common.errors.RecordDeserializationException: Error deserializing key/value for partition basic-topic-01-2 at offset 5. If needed, please seek past the record to continue consumption.</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher.parseRecord(Fetcher.java:1448) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher.access$3400(Fetcher.java:135) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher$CompletedFetch.fetchRecords(Fetcher.java:1671) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher$CompletedFetch.access$1900(Fetcher.java:1507) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher.fetchRecords(Fetcher.java:733) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher.fetchedRecords(Fetcher.java:684) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.KafkaConsumer.pollForFetches(KafkaConsumer.java:1277) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1238) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.apache.kafka.clients.consumer.KafkaConsumer.poll(KafkaConsumer.java:1211) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.pollConsumer(KafkaMessageListenerContainer.java:1522) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doPoll(KafkaMessageListenerContainer.java:1512) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.pollAndInvoke(KafkaMessageListenerContainer.java:1340) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:1252) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    ... 4 common frames omitted</span><br><span class="line">Caused by: java.lang.IllegalStateException: No type information in headers and no default type provided</span><br><span class="line">    at org.springframework.util.Assert.state(Assert.java:76) ~[spring-core-5.3.21.jar:5.3.21]</span><br><span class="line">    at org.springframework.kafka.support.serializer.JsonDeserializer.deserialize(JsonDeserializer.java:583) ~[spring-kafka-2.8.7.jar:2.8.7]</span><br><span class="line">    at org.apache.kafka.clients.consumer.internals.Fetcher.parseRecord(Fetcher.java:1439) ~[kafka-clients-3.1.1.jar:na]</span><br><span class="line">    ... 16 common frames omitted</span><br></pre></td></tr></table></figure>
<p>물론 공식 문서에도 나와있다.<br>(하지만 우리는 에러가 발생하기 전까지는 공식 문서를 잘 안..=3=3)</p>
<p>어쨌든 ErrorHandlingDeserializer 설정 방법이나 알아보자.</p>
<h3 id="ErrorHandlingDeserializer"><a href="#ErrorHandlingDeserializer" class="headerlink" title="ErrorHandlingDeserializer"></a>ErrorHandlingDeserializer</h3><p>스프링 카프카 설정 방법은 여러가지인데 결국에는 KafkaConsumerFactory에 ErrorHandlingDeserializer를 지정해주면 된다.</p>
<p>소스 코드로는 대략 다음과 같이 작성하면 되고,</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from https://docs.spring.io/spring-kafka/reference/html/#error-handling-deserializer</span></span><br><span class="line"></span><br><span class="line">... <span class="comment">// other props</span></span><br><span class="line">props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, ErrorHandlingDeserializer.<span class="keyword">class</span>);</span><br><span class="line">props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ErrorHandlingDeserializer.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">props.put(ErrorHandlingDeserializer.KEY_DESERIALIZER_CLASS, JsonDeserializer.<span class="keyword">class</span>);</span><br><span class="line">props.put(ErrorHandlingDeserializer.VALUE_DESERIALIZER_CLASS, JsonDeserializer.<span class="keyword">class</span>.getName());</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> DefaultKafkaConsumerFactory&lt;&gt;(props);</span><br></pre></td></tr></table></figure>
<p>yml로 다음과 같이 작성해도 효과는 같다.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span>  </span><br><span class="line"><span class="attr">  kafka:</span></span><br><span class="line"><span class="attr">    consumer:</span></span><br><span class="line"><span class="attr">      bootstrap-servers:</span></span><br><span class="line"><span class="attr">        - localhost:</span><span class="number">29092</span></span><br><span class="line"><span class="attr">      key-deserializer:</span> <span class="string">org.springframework.kafka.support.serializer.ErrorHandlingDeserializer</span></span><br><span class="line"><span class="attr">      value-deserializer:</span> <span class="string">org.springframework.kafka.support.serializer.ErrorHandlingDeserializer</span></span><br><span class="line"><span class="attr">      properties:</span></span><br><span class="line"><span class="attr">        spring:</span></span><br><span class="line"><span class="attr">          deserializer:</span></span><br><span class="line"><span class="attr">            key:</span></span><br><span class="line"><span class="attr">              delegate:</span></span><br><span class="line"><span class="attr">                class:</span> <span class="string">org.springframework.kafka.support.serializer.JsonDeserializer</span></span><br><span class="line"><span class="attr">            value:</span></span><br><span class="line"><span class="attr">              delegate:</span></span><br><span class="line"><span class="attr">                class:</span> <span class="string">org.springframework.kafka.support.serializer.JsonDeserializer</span></span><br></pre></td></tr></table></figure>
<p>결국 <strong>ErrorHandlingDeserializer로 JsonDeserializer를 감싸서, 에러가 있으면 ErrorHandler에게 넘기고, 에러가 없으면 JsonDeserializer에게 넘기는 구조다.</strong></p>
<h3 id="ErrorHandler"><a href="#ErrorHandler" class="headerlink" title="ErrorHandler"></a>ErrorHandler</h3><p>에러 핸들러 지정 방식도 여러가지인데 가장 간단하게는 KafkaListenerContainerFactory에 ErrorHandler를 지정해주면 된다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">kafkaListenerContainerFactory</span><span class="params">()</span></span>: ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">val</span> factory = ConcurrentKafkaListenerContainerFactory&lt;String, String&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ErrorHandler 지정</span></span><br><span class="line">    factory.setCommonErrorHandler(                  </span><br><span class="line">        DefaultErrorHandler &#123; record, exception -&gt;</span><br><span class="line">            log.error(</span><br><span class="line">                <span class="string">"""</span></span><br><span class="line"><span class="string">                    Consume 실패!!!</span></span><br><span class="line"><span class="string">                    cause: <span class="subst">$&#123;exception.message&#125;</span></span></span><br><span class="line"><span class="string">                    topic: <span class="subst">$&#123;record.topic()&#125;</span></span></span><br><span class="line"><span class="string">                    partition: <span class="subst">$&#123;record.partition()&#125;</span></span></span><br><span class="line"><span class="string">                    offset: <span class="subst">$&#123;record.offset()&#125;</span></span></span><br><span class="line"><span class="string">                    message key: <span class="subst">$&#123;record.key()&#125;</span></span></span><br><span class="line"><span class="string">                    message value: <span class="subst">$&#123;record.value()&#125;</span></span></span><br><span class="line"><span class="string">                    <span class="subst">$&#123;exception.stackTraceToString()&#125;</span></span></span><br><span class="line"><span class="string">                """</span>.trimIndent()</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    factory.consumerFactory = consumerFactory()  <span class="comment">// 앞서 ErrorHandlingDeserializer 설정할 때 만든 DefaultKafkaConsumerFactory</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> factory</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>단순히 로깅만으로 끝내도 되면 위와 같이 간단히 처리할 수 있고, 그게 아니라면 dead-letter topic으로 전송되게 할 수도 있다.</p>
<p>dead-letter topic 관련은 <a href="https://docs.spring.io/spring-kafka/reference/html/#dead-letters" target="_blank" rel="noopener">https://docs.spring.io/spring-kafka/reference/html/#dead-letters</a> 를 참고하자.</p>
<p>이밖에도 @KafkaListener에서 에러 처리를 지정할 수도 있고,<br><code>consumerProps.put(ErrorHandlingDeserializer.VALUE_FUNCTION, FailedFooProvider.class)</code> 이런 식으로 역직렬화에 실패한 메시지 대신에 다른 fallback 메시지를 만들어서 리스너에게 전달해줄 수도 있다.</p>
<h2 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h2><blockquote>
<ul>
<li><strong>카프카 스프링 컨수머에서 역직렬화에 실패하면 완전히 새된다.</strong></li>
<li>StringDeserializer를 사용하면 역직렬화 실패 가능성은 매우 낮아지지만, 실제 비즈니스에서 사용하려면 역직렬화한 문자열을 다시 업무에 사용하는 데이터 타입으로 변환해줘야 한다.</li>
<li>이 과정을 JSON으로 한 번에 해주는 게 JsonDeserializer</li>
<li>하지만 JsonDeserializer를 날로 그냥 먹으면 심각한 식중독에 걸릴 수 있다.</li>
<li><strong>JsonDeserializer 사용 등 역직렬화 오류가 발생할 수 있는 상황에서는 반드시 ErrorHandlingDeserializer를 사용해야 Poison Pill로 인한 장애를 막을 수 있다.</strong></li>
</ul>
</blockquote>
<h2 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h2><ul>
<li><a href="https://docs.spring.io/spring-kafka/reference/html/#error-handling-deserializer" target="_blank" rel="noopener">https://docs.spring.io/spring-kafka/reference/html/#error-handling-deserializer</a></li>
<li><a href="https://www.confluent.io/ko-kr/blog/spring-kafka-can-your-kafka-consumers-handle-a-poison-pill/" target="_blank" rel="noopener">https://www.confluent.io/ko-kr/blog/spring-kafka-can-your-kafka-consumers-handle-a-poison-pill/</a></li>
</ul>

        
        
            
        
        <hr/>
        <div>
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="크리에이티브 커먼즈 라이선스" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><a href='https://github.com/homoefficio' target='_blank'>HomoEfficio</a>가 작성한 이 저작물은(는) <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">크리에이티브 커먼즈 저작자표시-비영리-동일조건변경허락 4.0 국제 라이선스</a>에 따라 이용할 수 있습니다.
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Consumer/">Consumer</a> <a class="tag tag--primary tag--small t-link" href="/tags/Deserializer/">Deserializer</a> <a class="tag tag--primary tag--small t-link" href="/tags/ErrorHandlingDeserializer/">ErrorHandlingDeserializer</a> <a class="tag tag--primary tag--small t-link" href="/tags/Kafka/">Kafka</a> <a class="tag tag--primary tag--small t-link" href="/tags/Poison-Pill/">Poison Pill</a> <a class="tag tag--primary tag--small t-link" href="/tags/Spring/">Spring</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2022/05/21/Zero-Downtime-Migration-Design/" data-tooltip="Zero Downtime Migration - Design">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 HomoEfficio. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2022/05/21/Zero-Downtime-Migration-Design/" data-tooltip="Zero Downtime Migration - Design">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2022/08/28/Kafka-Poison-Pill-Spring-ErrorHandlingDeserializer/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=110"/>
        
            <h4 id="about-card-name">HomoEfficio</h4>
        
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Seoul, Korea.
            </h5>
        
    </div>
</div>
        <div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'hanmomhanda';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>



</html>
