<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="뒤태지존의 끄적거림">
    <title>Quartz 스케줄러 적용 아키텍처 개선 - 1 - 뒤태지존의 끄적거림</title>
    <meta name="author" content="HomoEfficio">
    <meta name="description" content="뒤태지존의 끄적거림">
    
        <link rel="icon" href="/assets/images/favicon.ico">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Quartz 스케줄러 적용 아키텍처 개선 - 1Quartz는 스프링에서도 지원하고 있어서 스프링 기반 프로젝트에도 쉽게 통합해서 사용할 수 있으므로 널리 사용되고 있다. 게다가 properties 파일 설정만으로 간단하게 클러스터를 구성해서 부하 분산 및 fail-over가 가능한 것도 장점이다. Quartz에 나오는 주요 등장 인물에 대한 설명이나 기본">
<meta name="keywords" content="Java,자바,Quartz,Scheduler,Clean Architecture,Interface Segregation Principle,Dependency Inversion Principle,Isolation,쿼츠,스케줄러,클린 아키텍처,인터페이스 분리 원칙,의존관계 역전 원칙,격리">
<meta property="og:type" content="blog">
<meta property="og:title" content="Quartz 스케줄러 적용 아키텍처 개선 - 1">
<meta property="og:url" content="http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/index.html">
<meta property="og:site_name" content="뒤태지존의 끄적거림">
<meta property="og:description" content="Quartz 스케줄러 적용 아키텍처 개선 - 1Quartz는 스프링에서도 지원하고 있어서 스프링 기반 프로젝트에도 쉽게 통합해서 사용할 수 있으므로 널리 사용되고 있다. 게다가 properties 파일 설정만으로 간단하게 클러스터를 구성해서 부하 분산 및 fail-over가 가능한 것도 장점이다. Quartz에 나오는 주요 등장 인물에 대한 설명이나 기본">
<meta property="og:locale" content="ko">
<meta property="og:image" content="https://i.imgur.com/JB5c5mF.jpg">
<meta property="og:image" content="https://i.imgur.com/XDItlAj.png">
<meta property="og:image" content="https://i.imgur.com/4BFS4lx.png">
<meta property="og:image" content="https://i.imgur.com/gF10uft.png">
<meta property="og:updated_time" content="2019-09-29T05:16:57.969Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Quartz 스케줄러 적용 아키텍처 개선 - 1">
<meta name="twitter:description" content="Quartz 스케줄러 적용 아키텍처 개선 - 1Quartz는 스프링에서도 지원하고 있어서 스프링 기반 프로젝트에도 쉽게 통합해서 사용할 수 있으므로 널리 사용되고 있다. 게다가 properties 파일 설정만으로 간단하게 클러스터를 구성해서 부하 분산 및 fail-over가 가능한 것도 장점이다. Quartz에 나오는 주요 등장 인물에 대한 설명이나 기본">
<meta name="twitter:image" content="https://i.imgur.com/JB5c5mF.jpg">
    
        <meta rel="publisher" content="https://plus.google.com/+오명운"/>
    
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=640"/>
    
    
        <meta property="og:image" content="/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/https:/avatars1.githubusercontent.com/u/5505009?s=200&v=4"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/https://avatars1.githubusercontent.com/u/5505009?s=200&v=4" />
    
    
        <meta property="og:image" content="/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/cover-schedule.jpg"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/cover-schedule.jpg" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-79893978-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6494847158566766",
    enable_page_level_ads: true
  });
</script>
</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">뒤태지존의 끄적거림</a>
    </h1>
    
        <a class="header-right-picture" href="/#about">
            <img class="header-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=90"/>
        </a>
    
</header>
            <nav id="sidebar" data-behavior="1">
    
    <div class="sidebar-profile">
        <a href="/#about">
            
            <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=90"/>
            
        </a>
        <span class="sidebar-profile-name">HomoEfficio</span>
    </div>
    
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/ 
                    ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-categories
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-tags
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-archives
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link st-search-show-outputs"
                    href="#search
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="#about
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About me</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://github.com/HomoEfficio" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="mailto:homo.efficio@gmail.com" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/atom.xml
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>
            <div id="main" data-behavior="1">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
        <div class="post-header-cover" style="background-image:url('/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/cover-schedule.jpg');">
            <div class="post-header main-content-wrap">
    
        <h1 class="post-title" itemprop="headline">Quartz 스케줄러 적용 아키텍처 개선 - 1</h1>
    
    <div class="post-meta">
    <time  itemprop="datePublished" content="Sat Sep 28 2019 18:01:09 GMT+0900">
        Sep 28, 2019
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Technique/">Technique</a>


    
</div>
</div>
        </div>
    
    <div class="post-content markdown main-content-wrap" itemprop="articleBody">
        
            <h1 id="Quartz-스케줄러-적용-아키텍처-개선-1"><a href="#Quartz-스케줄러-적용-아키텍처-개선-1" class="headerlink" title="Quartz 스케줄러 적용 아키텍처 개선 - 1"></a>Quartz 스케줄러 적용 아키텍처 개선 - 1</h1><p>Quartz는 스프링에서도 지원하고 있어서 스프링 기반 프로젝트에도 쉽게 통합해서 사용할 수 있으므로 널리 사용되고 있다. 게다가 properties 파일 설정만으로 간단하게 클러스터를 구성해서 부하 분산 및 fail-over가 가능한 것도 장점이다.</p>
<p>Quartz에 나오는 주요 등장 인물에 대한 설명이나 기본 사용 방법은 검색해보면 많이 나오므로 여기에서는 생략하고 실제 적용할 때 필요한 아키텍처 개선에만 초점을 맞춘다. 관련 코드 역시 주요 부분만 표시하면서 진행한다.</p>
<p>OpenJDK 9, 그레이들 5.6.2, 스프링부트 2.1.8, 스프링 5.1.9, Quartz 2.3.1 기준이다.</p>
<h1 id="Quartz-실행-흐름"><a href="#Quartz-실행-흐름" class="headerlink" title="Quartz 실행 흐름"></a>Quartz 실행 흐름</h1><p>Quartz 실행 흐름은 다음 그림에 잘 정리돼 있다. 간단하게 요약하면 <code>Scheduler</code>가 <code>Job</code>의 실행 정보를 통해 정해진 시간이나 정해진 주기로 <code>Job</code>을 실행한다.</p>
<p><img src="https://i.imgur.com/JB5c5mF.jpg" alt="Imgur"></p>
<p>그림 출처: <a href="https://examples.javacodegeeks.com/enterprise-java/quartz/java-quartz-architecture-example/" target="_blank" rel="noopener">https://examples.javacodegeeks.com/enterprise-java/quartz/java-quartz-architecture-example/</a></p>
<h1 id="문제"><a href="#문제" class="headerlink" title="문제"></a>문제</h1><p>그림에서 보듯 실행 흐름 관점에서 보면 <code>Scheduler</code>가 <code>Job</code>을 사용하며 <code>Job</code>에 의존하고 있다. 하지만 <code>Scheduler</code>는 사실 상 Quartz 프레임워크 그 자체로서 안정적인 모듈이고, <code>Job</code>은 <code>Scheduler</code>에 의해 실행될 실제 작업에 대한 로직이 포함돼 있어 변경 빈도가 더 높고, <code>Job</code> 자체가 추가/삭제되는 일도 빈번하므로 불안정하다. 안정적인 모듈이 불안정한 모듈에 의존하는 것은 좋지 않다. Quartz 개발자들이 이런 사실을 모를 리 없다.</p>
<p>그래서 <code>Job</code>은 사실 인터페이스다. 그리고 <code>Scheduler</code>에 의해 실행되는 실제 작업들은 <code>Job</code> 인터페이스의 구현체 들이다. 즉 Quartz 자체는 <code>Scheduler</code>와 <code>Job</code> 구현체를 분리할 수 있게 잘 설계돼 있다.</p>
<p>그런데 이렇게 <strong>분리할 수 있음에도 불구하고 <code>Scheduler</code>와 <code>Job</code> 인터페이스의 구현체를 같은 서버 안에 두면서 문제가 시작된다.</strong> 작업을 추가하려면 스케줄러까지 재배포를 해야 되며, 스케줄러 재배포는 스케줄러의 중단을 의미하므로 실행되는 작업이 없을 때만 가능하며, 많은 작업이 스케줄링 돼 있다면 재배포 타이밍을 잡기가 어려워진다. 따라서 스케줄러 본체인 <code>Scheduler</code>와 작업 클래스인 <code>Job</code> 구현체를 분리해서 별도로 배포할 수 있으면 이 문제를 해결할 수 있다.</p>
<p>하지만 인터넷에서 찾을 수 있는 대부분의 Quartz 사용법이나 예제는 <code>Scheduler</code>와 <code>Job</code> 구현체를 동일한 서버 인스턴스에 일체형으로 묶어둔 아키텍처를 기준으로 설명하고 있다. 아마도 Quartz의 사용법 자체에 중점을 두기 때문이겠지만, 이유야 어찌됐든 자료가 그러하므로 결국 실제 프로젝트에 적용할 때도 일체형으로 구성하는 곳이 많은 것 같다.</p>
<p>이제 스케줄러와 작업 클래스를 분리해서 별도로 배포할 수 있게 만들고 클린 아키텍처에 한 걸음 다가가보자. 3가지 고개를 넘어야 한다.</p>
<h1 id="클래스로딩"><a href="#클래스로딩" class="headerlink" title="클래스로딩"></a>클래스로딩</h1><p>스케줄러가 작업을 스케줄하려면 작업 클래스를 로딩하고 실행 주기를 지정해야 한다. 대략 다음과 같다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Init Runner executed."</span>);</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(<span class="string">"jobkey1"</span>, <span class="string">"jobgroup1"</span>);</span><br><span class="line">        JobDetail jobDetail = buildJobDetail(jobKey);</span><br><span class="line">        Trigger trigger = buildJobTrigger(jobKey);</span><br><span class="line">        scheduler.scheduleJob(jobDetail, trigger);  <span class="comment">// (1)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JobDetail <span class="title">buildJobDetail</span><span class="params">(JobKey jobKey)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        JobDataMap jobDataMap = <span class="keyword">new</span> JobDataMap();</span><br><span class="line">        jobDataMap.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">        jobDataMap.put(<span class="string">"key2"</span>, <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(SimpleJob.class)  <span class="comment">// (2)</span></span><br><span class="line">                .withIdentity(jobKey)</span><br><span class="line">                .withDescription(<span class="string">"Simple Quartz Job Detail"</span>)</span><br><span class="line">                .usingJobData(jobDataMap)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Trigger <span class="title">buildJobTrigger</span><span class="params">(JobKey jobKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .forJob(jobKey)</span><br><span class="line">                .withDescription(<span class="string">"Simple Quartz Job Trigger"</span>)</span><br><span class="line">                .startNow()  <span class="comment">// 스케줄링 되면 바로 실행되는 방식</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"OOO JOB [&#123;&#125;] executed."</span>, <span class="keyword">this</span>.getClass().getSimpleName());</span><br><span class="line">        JobDataMap mergedJobDataMap = context.getMergedJobDataMap();</span><br><span class="line">        mergedJobDataMap.forEach((k, v) -&gt; log.info(<span class="string">"OOOOO &#123;&#125;: &#123;&#125;"</span>, k, v));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>스케줄러에 의해 실행되는 <code>SimpleJob</code>은 단순하게 <code>JobExecutionContext</code>에 담겨 있는 키-밸류를 출력한다.</p>
<p>(1)과 같이 <code>JobDetail</code>과 <code>Trigger</code>를 <code>Scheduler</code>에 전달해주면 스케줄링 된다. 실행될 작업의 클래스는 (2)와 같이 클래스 리터럴 형태로 <code>JobDetail</code>에 지정된다. <code>Trigger</code>는 편의상 (3)과 같이 바로 실행되는 방식으로 지정했지만 Cron Expression 등 다양한 방식으로 지정할 수 있다.</p>
<p>실행해보면 다음과 같이 <code>SimpleJob</code>이 실행된다.</p>
<p><img src="https://i.imgur.com/XDItlAj.png" alt="Imgur"></p>
<h2 id="커스텀-클래스로더"><a href="#커스텀-클래스로더" class="headerlink" title="커스텀 클래스로더"></a>커스텀 클래스로더</h2><p>아키텍처 관점에서 중요한 지점은 (2)다. 일체형일 때는 위와 같이 직접 <code>SimpleJob.class</code>로 지정해주면 되지만, 분리돼 있다면 해당 클래스를 외부에서 읽어와야 한다. 따라서 다음과 같이 <code>URLClassLoader</code>를 활용해서 <code>JOB_REPO</code>로 지정된 jar 파일에 있는 작업 클래스를 로딩할 수 있는 커스텀 클래스로더가 필요하다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteJobClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_REPO = <span class="string">"/tmp/homo-efficio/quartz/remote-job-repo/quartz-job.jar"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Class&lt;? extends T&gt; loadClass(String name, Class&lt;T&gt; clazz) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> (Class&lt;? extends T&gt;) getClassLoader().loadClass(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> URLClassLoader(</span><br><span class="line">                    <span class="keyword">new</span> URL[] &#123;</span><br><span class="line">                            <span class="keyword">new</span> File(JOB_REPO).toURI().toURL()</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="comment">// URLClassLoader 설정 시 parent를 webAppClassLoader로 지정해줘야</span></span><br><span class="line">                    <span class="comment">// org.quartz.Job 등 내부 의존 클래스 로딩 가능</span></span><br><span class="line">                    <span class="keyword">this</span>.getClass().getClassLoader()</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>자바 클래스로딩은 <a href="https://homoefficio.github.io/2018/10/13/Java-클래스로더-훑어보기/">https://homoefficio.github.io/2018/10/13/Java-클래스로더-훑어보기/</a> 와 <a href="https://homoefficio.github.io/2018/10/14/Java-URLClassLoader로-알아보는-클래스로딩/">https://homoefficio.github.io/2018/10/14/Java-URLClassLoader로-알아보는-클래스로딩/</a> 를 보면 도움이 될 것이다.</p>
<h2 id="작업-클래스-외부화"><a href="#작업-클래스-외부화" class="headerlink" title="작업 클래스 외부화"></a>작업 클래스 외부화</h2><p>이제 작업 클래스를 외부로 분리해보자. 지금까지 만든 파일은 모두 <code>quartz-scheduler</code>에 있고, 새로 <code>quartz-job</code> 모듈을 만들어서 작업 클래스는 모두 이 모듈에 둔다.</p>
<p><img src="https://i.imgur.com/4BFS4lx.png" alt="Imgur"></p>
<p><code>quartz-job</code> 모듈의 <code>build.gradle</code> 파일은 다음과 같이 작성한다. jar 파일을 <code>RemoteJobClassLoader</code>가 읽을 수 있는 위치에 배포하는 <code>deployJar</code> 태스크를 추가했다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id &apos;java&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">version &apos;unspecified&apos;</span><br><span class="line"></span><br><span class="line">sourceCompatibility = &apos;9&apos;</span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compileOnly &apos;org.projectlombok:lombok:1.18.8&apos;</span><br><span class="line">    annotationProcessor &apos;org.projectlombok:lombok:1.18.8&apos;</span><br><span class="line">    compile group: &apos;org.quartz-scheduler&apos;, name: &apos;quartz&apos;, version: &apos;2.3.1&apos;</span><br><span class="line">    compile group: &apos;org.springframework&apos;, name: &apos;spring-context-support&apos;, version: &apos;5.1.9.RELEASE&apos;</span><br><span class="line"></span><br><span class="line">    testCompile group: &apos;junit&apos;, name: &apos;junit&apos;, version: &apos;4.12&apos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task deployJar(type: Copy) &#123;</span><br><span class="line">    dependsOn(&apos;jar&apos;)</span><br><span class="line">    from &quot;$buildDir/libs/quartz-job.jar&quot;</span><br><span class="line">    into &quot;/tmp/homo-efficio/quartz/remote-job-repo/&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>아까 나왔던 <code>SimpleJob</code>과 거의 동일한 내용의 <code>RemoteSimpleJob</code> 클래스를 <code>quartz-job</code> 아래에 만든다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteSimpleJob</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"OOO REMOTE JOB [&#123;&#125;] executed."</span>, <span class="keyword">this</span>.getClass().getSimpleName());</span><br><span class="line">        JobDataMap mergedJobDataMap = context.getMergedJobDataMap();</span><br><span class="line">        mergedJobDataMap.forEach((k, v) -&gt; log.info(<span class="string">"OOOOO &#123;&#125;: &#123;&#125;"</span>, k, v));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>작업 스케줄링 하는 부분을 다음과 같이 <code>RemoteJobClassLoader</code>를 사용해서 작업 클래스를 로딩하도록 바꾼다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RemoteJobClassLoader remoteJobClassLoader;  <span class="comment">// 여기!!</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Init Runner executed."</span>);</span><br><span class="line">        JobKey jobKey = JobKey.jobKey(<span class="string">"jobkey1"</span>, <span class="string">"jobgroup1"</span>);</span><br><span class="line">        JobDetail jobDetail = buildJobDetail(jobKey);</span><br><span class="line">        Trigger trigger = buildJobTrigger(jobKey);</span><br><span class="line">        scheduler.scheduleJob(jobDetail, trigger);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> JobDetail <span class="title">buildJobDetail</span><span class="params">(JobKey jobKey)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        JobDataMap jobDataMap = <span class="keyword">new</span> JobDataMap();</span><br><span class="line">        jobDataMap.put(<span class="string">"key1"</span>, <span class="string">"value1"</span>);</span><br><span class="line">        jobDataMap.put(<span class="string">"key2"</span>, <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 여기!!</span></span><br><span class="line"><span class="comment">//        return JobBuilder.newJob(SimpleJob.class)</span></span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(remoteJobClassLoader.loadClass(<span class="string">"io.homo_efficio.quartz.job.RemoteSimpleJob"</span>, Job.class))</span><br><span class="line">                .withIdentity(jobKey)</span><br><span class="line">                .withDescription(<span class="string">"Simple Quartz Job Detail"</span>)</span><br><span class="line">                .usingJobData(jobDataMap)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Trigger <span class="title">buildJobTrigger</span><span class="params">(JobKey jobKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .forJob(jobKey)</span><br><span class="line">                .withDescription(<span class="string">"Simple Quartz Job Trigger"</span>)</span><br><span class="line">                .startNow()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이제 다시 애플리케이션을 실행해보면 다음과 같이 분리된 별도의 jar 파일에서 작업 클래스를 로딩해서 실행하는 것을 확인할 수 있다.</p>
<p><img src="https://i.imgur.com/gF10uft.png" alt="Imgur"></p>
<p>스케줄러쪽에서 <code>io.homo_efficio.quartz.job.RemoteSimpleJob</code>와 같이 외부 jar에 있는 작업 클래스 위치를 문자열로 직접 참조하고 있어서 마치 스케줄러 모듈(quartz-scheduler)이 작업 모듈(quartz-job)에 의존하는 것처럼 보이지만, 실무에서는 작업 클래스 위치나 실행 주기 정보를 DB에서 읽어오므로 실제 환경에서는 <strong>스케줄러 모듈은 작업 클래스 모듈을 모른다. 따라서 이제부터는 <code>RemoteJob2</code>, <code>RemoteJob3</code> 등을 추가하더라도 <code>quartz-job.jar</code>만 빌드/배포하면 되며, 스케줄러는 재배포할 필요가 없는 구조가 만들어졌다.</strong></p>
<p>이렇게 해서 스케줄러와 작업 클래스를 분리하는데 성공했다. 어렵지 않다. </p>
<p>그런데 실무에서 사용하는 작업 클래스들이 <code>RemoteSimpleJob</code>처럼 단순할리는 없다. DB 작업도 있을 것이고 하둡 인프라와 관련한 작업도 있을 것이다. 이런 것들이 가능하려면 스케줄러 쪽에 있는 컴포넌트를 <code>@Autowire</code>로 주입 받아야 하는데, 지금처럼 런타임에 로딩되는 방식에서도 가능할까?</p>
<p>첫번째 고개만으로도 양이 제법되니 일단 여기서 1탄을 마무리하고 <code>@Autowire</code>는 <a href="https://homoefficio.github.io/2019/09/29/Quartz-스케줄러-적용-아키텍처-개선-2/">2탄</a>에서 다룬다.</p>
<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><blockquote>
<ul>
<li><p>스케줄링을 담당하는 스케줄러와 실행되는 작업은 변경 주기가 다르다. 그런데 이를 한 곳에 모아 일체형으로 구성하면 운영이 매우 불편해진다.</p>
</li>
<li><p>Quartz는 스케줄러와 작업을 분리할 수 있도록 설계되어 있다.</p>
</li>
<li><p>작업 클래스를 별도의 jar로 묶고, 스케줄러 쪽에서 <code>URLClassLoader</code>를 사용해서 작업 클래스를 로딩하도록 개선하면 스케줄러와 작업 클래스의 배포를 분리할 수 있어 운영 부담을 대폭 줄일 수 있다.</p>
</li>
</ul>
</blockquote>

        
        
            
        
        <hr/>
        <div>
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="크리에이티브 커먼즈 라이선스" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><a href='https://github.com/homoefficio' target='_blank'>HomoEfficio</a>가 작성한 이 저작물은(는) <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">크리에이티브 커먼즈 저작자표시-비영리-동일조건변경허락 4.0 국제 라이선스</a>에 따라 이용할 수 있습니다.
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Clean-Architecture/">Clean Architecture</a> <a class="tag tag--primary tag--small t-link" href="/tags/Dependency-Inversion-Principle/">Dependency Inversion Principle</a> <a class="tag tag--primary tag--small t-link" href="/tags/Interface-Segregation-Principle/">Interface Segregation Principle</a> <a class="tag tag--primary tag--small t-link" href="/tags/Isolation/">Isolation</a> <a class="tag tag--primary tag--small t-link" href="/tags/Java/">Java</a> <a class="tag tag--primary tag--small t-link" href="/tags/Quartz/">Quartz</a> <a class="tag tag--primary tag--small t-link" href="/tags/Scheduler/">Scheduler</a> <a class="tag tag--primary tag--small t-link" href="/tags/격리/">격리</a> <a class="tag tag--primary tag--small t-link" href="/tags/스케줄러/">스케줄러</a> <a class="tag tag--primary tag--small t-link" href="/tags/의존관계-역전-원칙/">의존관계 역전 원칙</a> <a class="tag tag--primary tag--small t-link" href="/tags/인터페이스-분리-원칙/">인터페이스 분리 원칙</a> <a class="tag tag--primary tag--small t-link" href="/tags/자바/">자바</a> <a class="tag tag--primary tag--small t-link" href="/tags/쿼츠/">쿼츠</a> <a class="tag tag--primary tag--small t-link" href="/tags/클린-아키텍처/">클린 아키텍처</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/09/29/Quartz-스케줄러-적용-아키텍처-개선-2/"  data-tooltip="Quartz 스케줄러 적용 아키텍처 개선 - 2">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/07/04/객체-지향-프로그래밍과-메시징/" data-tooltip="객체 지향 프로그래밍과 메시징">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 HomoEfficio. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/09/29/Quartz-스케줄러-적용-아키텍처-개선-2/"  data-tooltip="Quartz 스케줄러 적용 아키텍처 개선 - 2">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/07/04/객체-지향-프로그래밍과-메시징/" data-tooltip="객체 지향 프로그래밍과 메시징">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2019/09/28/Quartz-스케줄러-적용-아키텍처-개선-1/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=110"/>
        
            <h4 id="about-card-name">HomoEfficio</h4>
        
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Seoul, Korea.
            </h5>
        
    </div>
</div>
        <div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'hanmomhanda';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>



</html>
