<!DOCTYPE html>
<html lang="ko">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="뒤태지존의 끄적거림">
    <title>Spring Data에서 Batch Insert 최적화 - 뒤태지존의 끄적거림</title>
    <meta name="author" content="HomoEfficio">
    <meta name="description" content="뒤태지존의 끄적거림">
    
        <link rel="icon" href="/assets/images/favicon.ico">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta name="description" content="Spring Data에서 Batch Insert 최적화Spring Data JPA가 안겨주는 편리함 뒤에는 가끔 성능 손실이 숨어있다. 이번에 알아볼 Batch Insert도 그런 예 중 하나다. 성능 손실 문제가 발생하는 이유와 2가지 해결 방법을 알아본다. 전체 코드는 https://github.com/HomoEfficio/micro-benchmark-">
<meta name="keywords" content="Spring Data JPA,Hibernate,Spring Data,Spring Data JDBC,Batch Insert,MySQL,GenerationType,GenerationType.IDENTITY,GenerationType.SEQUENCE,GenerationType.TABLE,GenerationType.AUTO,Performance,IDENTITY column,Auto Increment,Sequence,Database,Bulk Insert">
<meta property="og:type" content="blog">
<meta property="og:title" content="Spring Data에서 Batch Insert 최적화">
<meta property="og:url" content="http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/index.html">
<meta property="og:site_name" content="뒤태지존의 끄적거림">
<meta property="og:description" content="Spring Data에서 Batch Insert 최적화Spring Data JPA가 안겨주는 편리함 뒤에는 가끔 성능 손실이 숨어있다. 이번에 알아볼 Batch Insert도 그런 예 중 하나다. 성능 손실 문제가 발생하는 이유와 2가지 해결 방법을 알아본다. 전체 코드는 https://github.com/HomoEfficio/micro-benchmark-">
<meta property="og:locale" content="ko">
<meta property="og:updated_time" content="2020-01-30T16:44:46.720Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Data에서 Batch Insert 최적화">
<meta name="twitter:description" content="Spring Data에서 Batch Insert 최적화Spring Data JPA가 안겨주는 편리함 뒤에는 가끔 성능 손실이 숨어있다. 이번에 알아볼 Batch Insert도 그런 예 중 하나다. 성능 손실 문제가 발생하는 이유와 2가지 해결 방법을 알아본다. 전체 코드는 https://github.com/HomoEfficio/micro-benchmark-">
    
        <meta rel="publisher" content="https://plus.google.com/+오명운"/>
    
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=640"/>
    
    
        <meta property="og:image" content="/2020/01/25/Spring-Data에서-Batch-Insert-최적화/https:/i.imgur.com/ttJDJ08.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/https://i.imgur.com/ttJDJ08.png" />
    
    
        <meta property="og:image" content="/2020/01/25/Spring-Data에서-Batch-Insert-최적화/cover-batch-insert.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/cover-batch-insert.png" />
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-79893978-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6494847158566766",
    enable_page_level_ads: true
  });
</script>
</head>

    <body>
        <div id="blog">
            <header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/ ">뒤태지존의 끄적거림</a>
    </h1>
    
        <a class="header-right-picture" href="/#about">
            <img class="header-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=90"/>
        </a>
    
</header>
            <nav id="sidebar" data-behavior="1">
    
    <div class="sidebar-profile">
        <a href="/#about">
            
            <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=90"/>
            
        </a>
        <span class="sidebar-profile-name">HomoEfficio</span>
    </div>
    
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/ 
                    ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-categories
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-tags
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/all-archives
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link st-search-show-outputs"
                    href="#search
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="#about
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About me</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="https://github.com/HomoEfficio" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link " href="mailto:homo.efficio@gmail.com" target="_blank">
            
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link "
                    href="/atom.xml
                            ">
            
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>
            <div id="main" data-behavior="1">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
        <div class="post-header-cover" style="background-image:url('/2020/01/25/Spring-Data에서-Batch-Insert-최적화/cover-batch-insert.png');">
            <div class="post-header main-content-wrap">
    
        <h1 class="post-title" itemprop="headline">Spring Data에서 Batch Insert 최적화</h1>
    
    <div class="post-meta">
    <time  itemprop="datePublished" content="Sat Jan 25 2020 23:06:24 GMT+0900">
        Jan 25, 2020
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Performance/">Performance</a>


    
</div>
</div>
        </div>
    
    <div class="post-content markdown main-content-wrap" itemprop="articleBody">
        
            <h1 id="Spring-Data에서-Batch-Insert-최적화"><a href="#Spring-Data에서-Batch-Insert-최적화" class="headerlink" title="Spring Data에서 Batch Insert 최적화"></a>Spring Data에서 Batch Insert 최적화</h1><p>Spring Data JPA가 안겨주는 편리함 뒤에는 가끔 성능 손실이 숨어있다. 이번에 알아볼 Batch Insert도 그런 예 중 하나다.</p>
<p>성능 손실 문제가 발생하는 이유와 2가지 해결 방법을 알아본다.</p>
<p>전체 코드는 <a href="https://github.com/HomoEfficio/micro-benchmark-spring-boot-batch-insert" target="_blank" rel="noopener">https://github.com/HomoEfficio/micro-benchmark-spring-boot-batch-insert</a> 여기에서 볼 수 있으며 아주 쉽게 직접 테스트해 볼 수도 있다.</p>
<h1 id="Batch-Insert란"><a href="#Batch-Insert란" class="headerlink" title="Batch Insert란?"></a>Batch Insert란?</h1><p>거창한 거 하나도 없다. 3건의 데이터를 insert 한다고 할 때,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table1 (col1, col2) <span class="keyword">VALUES</span> (val11, val12);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table1 (col1, col2) <span class="keyword">VALUES</span> (val21, val22);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table1 (col1, col2) <span class="keyword">VALUES</span> (val31, val32);</span><br></pre></td></tr></table></figure>
<p>이렇게 하면 개별 insert고,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> table1 (col1, col2) <span class="keyword">VALUES</span></span><br><span class="line">(val11, val12),</span><br><span class="line">(val21, val22),</span><br><span class="line">(val31, val32);</span><br></pre></td></tr></table></figure>
<p>이렇게 하면 batch insert다. 그냥 봐도 batch insert 쪽이 훨씬 효율적임을 쉽게 알 수 있다.</p>
<p>DB 관점에서보면 간단한데, Spring Data에서 저런 DML이 DB로 전달되게 하는 건 그렇게 간단하지만은 않다.</p>
<h1 id="Hibernate의-Batch-Insert-제약-사항"><a href="#Hibernate의-Batch-Insert-제약-사항" class="headerlink" title="Hibernate의 Batch Insert 제약 사항"></a>Hibernate의 Batch Insert 제약 사항</h1><p><a href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-session-batch-insert" target="_blank" rel="noopener">Hibernate 레퍼런스 문서 12.2.1. Batch inserts</a>의 바로 위에 다음과 같이 <strong>식별자 생성에 IDENTITY 방식을 사용하면 Hibernate가 JDBC 수준에서 batch insert를 비활성화</strong>한다고 나와있다.</p>
<blockquote>
<p>Hibernate disables insert batching at the JDBC level transparently if you use an identity identifier generator.</p>
</blockquote>
<p>비활성화하는 이유는 Hibernate 문서에는 없는 것 같아서 다시 찾아보니 StackOverflow에 <a href="https://stackoverflow.com/a/27732138" target="_blank" rel="noopener">Vlad Mihalcea가 올린 댓글</a>에서 단서를 찾을 수 있었다.</p>
<blockquote>
<p>The only drawback is that we can’t know the newly assigned value prior to executing the INSERT statement. This restriction is hindering the “transactional write behind” flushing strategy adopted by Hibernate. For this reason, Hibernates disables the JDBC batch support for entities using the IDENTITY generator.</p>
</blockquote>
<p>요는 <strong>새로 할당할 Key 값을 미리 알 수 없는 IDENTITY 방식을 사용할 때 Batch Support를 지원하면 Hibernate가 채택한 flush 방식인 ‘Transactional Write Behind’와 충돌이 발생하기 때문</strong>에, IDENTITY 방식에서는 Batch Insert를 비활성화 한다는 얘기다. 따라서 그냥 <strong>일상적으로 가장 널리 사용하는 IDENTITY 방식을 사용하면 Batch Insert는 동작하지 않는다.</strong></p>
<p>그렇다고 Batch Insert를 적용하기 위해 IDENTITY 방식말고 섣불리 SEQUENCE 방식이나 TABLE 방식을 잘못 사용하면 더 나쁜 결과를 불러올 수 있다. <strong>채번에 따른 부하가 상당히 큰 SEQUENCE 방식이나 TABLE 방식을 별다른 조치 없이 사용하면 Batch Insert를 쓸 수 없는 IDENTITY 방식보다 더 느리다.</strong> 자세한 내용은 <a href="https://github.com/HomoEfficio/dev-tips/blob/master/JPA-GenerationType-별-INSERT-성능-비교.md" target="_blank" rel="noopener">https://github.com/HomoEfficio/dev-tips/blob/master/JPA-GenerationType-별-INSERT-성능-비교.md</a> 를 참고한다. 나름 건질만한 내용이 꽤 있으니 꼭 한 번 보길 권한다.</p>
<p>문제 발생 원인에서 유추할 수 있는 해결 방법은 2가지가 있다. </p>
<ol>
<li>SEQUENCE나 TABLE 방식을 사용하면서 채번 부하를 낮추는 방법</li>
<li>아예 Spring Data JPA를 벗어나는 방법</li>
</ol>
<h1 id="채번-부하-절감"><a href="#채번-부하-절감" class="headerlink" title="채번 부하 절감"></a>채번 부하 절감</h1><p>Batch Insert를 사용할 수 없는 IDENTITY 방식 대신에 SEQUENCE나 TABLE 방식을 사용하면서 채번 부하를 낮추는 방법은 <a href="https://dev.to/smartyansh/best-possible-hibernate-configuration-for-batch-inserts-2a7a" target="_blank" rel="noopener">https://dev.to/smartyansh/best-possible-hibernate-configuration-for-batch-inserts-2a7a</a> 에서 찾을 수 있었다.</p>
<p>간단하게 정리하면 채번 자체를 Batch 방식으로 처리해서 채번 부하를 낮추는 방식이다.</p>
<h2 id="일반적인-채번"><a href="#일반적인-채번" class="headerlink" title="일반적인 채번"></a>일반적인 채번</h2><p>SEQUENCE 방식은 일반적으로 다음과 같이 사용한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.SEQUENCE)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 방식을 사용하면 Sequence를 지원하는 DB에서는 Sequence를 이용해서 채번한다. 아래는 Sequence를 지원하는 H2 DB를 사용했을 때 나오는 Hibernate 로그 일부다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Hibernate: call next value for hibernate_sequence</span><br><span class="line">Hibernate: call next value for hibernate_sequence</span><br><span class="line">Hibernate: call next value for hibernate_sequence</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Sequence를 지원하지 않는 DB에서는 Table을 이용해서 채번한다. 아래는 Sequence를 지원하지 않는 MySQL DB의 로그 일부다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">SET autocommit=0</span><br><span class="line">select next_val as id_val from hibernate_sequence for update</span><br><span class="line">update hibernate_sequence set next_val= 2 where next_val=1</span><br><span class="line">commit</span><br><span class="line">autocommit=1</span><br><span class="line">autocommit=0</span><br><span class="line">select next_val as id_val from hibernate_sequence for update</span><br><span class="line">update hibernate_sequence set next_val= 3 where next_val=2</span><br><span class="line">commit</span><br><span class="line">SET autocommit=1</span><br><span class="line">SET autocommit=0</span><br><span class="line">select next_val as id_val from hibernate_sequence for update</span><br><span class="line">update hibernate_sequence set next_val= 4 where next_val=3</span><br><span class="line">commit</span><br><span class="line">SET autocommit=1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>번호 하나 딸 때마다 쿼리를 2개씩 날리게 되므로 꽤 큰 부하가 발생될 것임을 짐작할 수 있다.</p>
<h2 id="Batch-채번"><a href="#Batch-채번" class="headerlink" title="Batch 채번"></a>Batch 채번</h2><p>채번 자체를 Batch로 처리하면 아래와 같이 500개씩 한꺼번에 채번해서 쿼리 횟수를 대폭 줄이고 성능을 높일 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">SET autocommit=0</span><br><span class="line">select next_val as id_val from hibernate_sequence for update</span><br><span class="line">update hibernate_sequence set next_val= 501 where next_val=1</span><br><span class="line">commit</span><br><span class="line">SET autocommit=1</span><br><span class="line">SET autocommit=0</span><br><span class="line">select next_val as id_val from hibernate_sequence for update</span><br><span class="line">update hibernate_sequence set next_val= 1001 where next_val=501</span><br><span class="line">commit</span><br><span class="line">SET autocommit=1</span><br><span class="line">SET autocommit=0</span><br><span class="line">select next_val as id_val from hibernate_sequence for update</span><br><span class="line">update hibernate_sequence set next_val= 1501 where next_val=1001</span><br><span class="line">commit</span><br><span class="line">SET autocommit=1</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Batch 채번은 다음과 같이 다소 복잡한 Hibernate 전용 애너테이션을 지정해야 한다. </p>
<p>채번 배치 크기도 애너테이션 내에서 지정해야 하므로 배치 크기 설정을 yml 파일로 외부화 할 수 없다는 단점이 있다. 또한 채번 배치 크기는 엔티티 클래스에서 Hibernate 애너테이션으로 지정해야 하고, Batch Insert의 배치 크기는 yml 파일로 지정하므로 두 값이 달라질 가능성이 있다는 것도 운영 상 단점이라고 할 수 있겠다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemSequence</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GenericGenerator</span>(</span><br><span class="line">            name = <span class="string">"SequenceGenerator"</span>,</span><br><span class="line">            strategy = <span class="string">"org.hibernate.id.enhanced.SequenceStyleGenerator"</span>,</span><br><span class="line">            parameters = &#123;</span><br><span class="line">                    <span class="meta">@Parameter</span>(name = <span class="string">"sequence_name"</span>, value = <span class="string">"hibernate_sequence"</span>),</span><br><span class="line">                    <span class="meta">@Parameter</span>(name = <span class="string">"optimizer"</span>, value = <span class="string">"pooled"</span>),</span><br><span class="line">                    <span class="meta">@Parameter</span>(name = <span class="string">"initial_value"</span>, value = <span class="string">"1"</span>),</span><br><span class="line">                    <span class="meta">@Parameter</span>(name = <span class="string">"increment_size"</span>, value = <span class="string">"500"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="meta">@GeneratedValue</span>(</span><br><span class="line">            strategy = GenerationType.SEQUENCE,</span><br><span class="line">            generator = <span class="string">"SequenceGenerator"</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Spring-Data-JDBC"><a href="#Spring-Data-JDBC" class="headerlink" title="Spring Data JDBC"></a>Spring Data JDBC</h1><p>Spring Data에는 JPA만 있는 것이 아니다. <a href="https://spring.io/projects/spring-data" target="_blank" rel="noopener">https://spring.io/projects/spring-data</a> 에 보면 상당히 다양한 저장소를 지원하는 서브 프로젝트가 많이 있으며, 지금처럼 관계형 데이터베이스에서는 JPA 대신 JDBC를 사용할 수도 있다.</p>
<h2 id="JdbcTemplate-batchUpdate"><a href="#JdbcTemplate-batchUpdate" class="headerlink" title="JdbcTemplate.batchUpdate()"></a>JdbcTemplate.batchUpdate()</h2><p>JdbcTemplate에는 Batch를 지원하는 <code>batchUpdate()</code> 메서드가 마련돼있다. 여러 가지로 Overloading 돼 있어서 편리한 메서드를 골라서 사용하면 되는데, 여기에서는 batch 크기를 지정할 수 있는 <code>BatchPreparedStatementSetter</code>를 사용하는 아래의 메서드를 사용해서 구현해본다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">batchUpdate(String sql, BatchPreparedStatementSetter pss)</span><br></pre></td></tr></table></figure>
<h2 id="주요-구현-부분"><a href="#주요-구현-부분" class="headerlink" title="주요 구현 부분"></a>주요 구현 부분</h2><p><code>ItemJdbc</code>라는 객체를 <code>ITEM_JDBC</code> 테이블에 Batch Insert로 저장한다고 가정하고, 주요 구현부를 살펴보면 다음과 같다. </p>
<p><code>batchSize</code> 변수를 통해 배치 크기를 지정하고, 전체 데이터를 배치 크기로 나눠서 Batch Insert를 실행하고, 자투리 데이터를 다시 Batch Insert로 저장한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemJdbcRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">ItemJdbcRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;batchSize&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> batchSize;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAll</span><span class="params">(List&lt;ItemJdbc&gt; items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> batchCount = <span class="number">0</span>;</span><br><span class="line">        List&lt;ItemJdbc&gt; subItems = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; items.size(); i++) &#123;</span><br><span class="line">            subItems.add(items.get(i));</span><br><span class="line">            <span class="keyword">if</span> ((i + <span class="number">1</span>) % batchSize == <span class="number">0</span>) &#123;</span><br><span class="line">                batchCount = batchInsert(batchSize, batchCount, subItems);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!subItems.isEmpty()) &#123;</span><br><span class="line">            batchCount = batchInsert(batchSize, batchCount, subItems);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"batchCount: "</span> + batchCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">batchInsert</span><span class="params">(<span class="keyword">int</span> batchSize, <span class="keyword">int</span> batchCount, List&lt;ItemJdbc&gt; subItems)</span> </span>&#123;</span><br><span class="line">        jdbcTemplate.batchUpdate(<span class="string">"INSERT INTO ITEM_JDBC (`NAME`, `DESCRIPTION`) VALUES (?, ?)"</span>,</span><br><span class="line">                <span class="keyword">new</span> BatchPreparedStatementSetter() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValues</span><span class="params">(PreparedStatement ps, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">                        ps.setString(<span class="number">1</span>, subItems.get(i).getName());</span><br><span class="line">                        ps.setString(<span class="number">2</span>, subItems.get(i).getDescription());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getBatchSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> subItems.size();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        subItems.clear();</span><br><span class="line">        batchCount++;</span><br><span class="line">        <span class="keyword">return</span> batchCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="실험-결과"><a href="#실험-결과" class="headerlink" title="실험 결과"></a>실험 결과</h1><p>어느 방식이 가장 빠를까?</p>
<p>아래와 같은 환경에서 테스트 해 본 결과 <strong>Spring Data JDBC 방식이 가장 빠르다.</strong></p>
<h2 id="테스트-환경"><a href="#테스트-환경" class="headerlink" title="테스트 환경"></a>테스트 환경</h2><ul>
<li>Java 11</li>
<li>Spring Boot 2.2.4</li>
<li>MySQL 5.7.18</li>
<li>Sprint Data JPA 2.2.4</li>
<li>Hibernate Core 5.4.10.Final</li>
<li>Hibernate Commons Annotations 5.1.0.Final</li>
<li>Sprint Data JDBC 1.1.4</li>
</ul>
<h2 id="성능-비교"><a href="#성능-비교" class="headerlink" title="성능 비교"></a>성능 비교</h2><p>그렇다면 얼마나 차이가 날까?</p>
<p>연관 관계 없이 단 하나의 엔티티만 저장하는 시나리오에서, 배치 크기를 바꿔가면서 10,000건의 데이터를 저장하는 실험 결과 소요 시간(초 단위) 및 비교 배율은 다음과 같다.</p>
<table>
<thead>
<tr>
<th>배치 크기</th>
<th>JDBC(A)</th>
<th>Batch SEQUENCE(B)</th>
<th>IDENTITY(C)</th>
<th>(B)/(A)</th>
<th>(C)/(A)</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>0.885</td>
<td>3.072</td>
<td>5.087</td>
<td>3.47</td>
<td>5.748022599</td>
</tr>
<tr>
<td>50</td>
<td>0.391</td>
<td>1.007</td>
<td>4.097</td>
<td>2.58</td>
<td>10.47826087</td>
</tr>
<tr>
<td>100</td>
<td>0.356</td>
<td>0.808</td>
<td>5.218</td>
<td>2.27</td>
<td>14.65730337</td>
</tr>
<tr>
<td>500</td>
<td>0.226</td>
<td>0.515</td>
<td>5.637</td>
<td>2.28</td>
<td>24.94247788</td>
</tr>
<tr>
<td>1000</td>
<td>0.216</td>
<td>0.480</td>
<td>6.241</td>
<td>2.22</td>
<td>28.89351852</td>
</tr>
<tr>
<td>5000</td>
<td>0.189</td>
<td>0.447</td>
<td>5.052</td>
<td>2.37</td>
<td>26.73015873</td>
</tr>
</tbody>
</table>
<p>배치 크기에 따라 다르지만, <strong>Spring Data JDBC의 <code>batchUpdate()</code>를 사용하는 방식이 Hibernate Batch Sequence 방식보다 대략 2 ~ 3배 정도 빠르고, Batch Insert가 사용되지 못 하는 Hibernate IDENTITY 방식보다는 5 ~ 25배 정도 빠르다.</strong> </p>
<p>MySQL에는 Sequence가 없으므로 SEQUENCE 방식을 지정했다고 하더라도 사실 상 TABLE 방식으로 동작했다는 것을 감안하면, <strong>Sequence가 지원되는 DB에서는 TABLE 방식보다 채번 부하가 더 적은 SEQUENCE 방식을 Batch 스타일로 사용하면 Spring Data JDBC 방식과 비슷한 성능을 보일 것 같다.</strong></p>
<h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><blockquote>
<ul>
<li><p><strong>아주 많은 수의 데이터를 한 꺼번에 입력할 때는 Spring Data JPA를 잠시 뒤로하고 Spring Data JDBC의 <code>batchUpdate()</code>를 활용하는 것도 좋다.</strong></p>
<ul>
<li>Spring Data JDBC는 Spring Data JPA와 함께 혼용해서 사용할 수도 있고,</li>
<li><code>@Transactional</code>을 통해 트랜잭션이 관리될 수 있으므로,</li>
<li>현실적으로 가장 나은 방법이다.</li>
</ul>
</li>
<li><p><strong>Spring Data JPA를 사용해야만 한다면 IDENTITY 방식 말고 Batch SEQUENCE 방식을 사용하는 것이 좋다.</strong></p>
<ul>
<li>그러나 이 방식은 애너테이션 지정이 필요 이상 복잡하고,</li>
<li>테이블 생성 시부터 적용하면 괜찮지만, 이미 ID 생성 방식이 IDENTITY인 기존 테이블을 SEQUENCE 방식으로 변경해야 하는 부담이 있고,</li>
<li>batch 크기 지정 관련 운영 상의 단점이 있다.</li>
</ul>
</li>
</ul>
</blockquote>

        
        
            
        
        <hr/>
        <div>
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="크리에이티브 커먼즈 라이선스" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><a href='https://github.com/homoefficio' target='_blank'>HomoEfficio</a>가 작성한 이 저작물은(는) <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">크리에이티브 커먼즈 저작자표시-비영리-동일조건변경허락 4.0 국제 라이선스</a>에 따라 이용할 수 있습니다.
        </div>
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Auto-Increment/">Auto Increment</a> <a class="tag tag--primary tag--small t-link" href="/tags/Batch-Insert/">Batch Insert</a> <a class="tag tag--primary tag--small t-link" href="/tags/Bulk-Insert/">Bulk Insert</a> <a class="tag tag--primary tag--small t-link" href="/tags/Database/">Database</a> <a class="tag tag--primary tag--small t-link" href="/tags/GenerationType/">GenerationType</a> <a class="tag tag--primary tag--small t-link" href="/tags/GenerationType-AUTO/">GenerationType.AUTO</a> <a class="tag tag--primary tag--small t-link" href="/tags/GenerationType-IDENTITY/">GenerationType.IDENTITY</a> <a class="tag tag--primary tag--small t-link" href="/tags/GenerationType-SEQUENCE/">GenerationType.SEQUENCE</a> <a class="tag tag--primary tag--small t-link" href="/tags/GenerationType-TABLE/">GenerationType.TABLE</a> <a class="tag tag--primary tag--small t-link" href="/tags/Hibernate/">Hibernate</a> <a class="tag tag--primary tag--small t-link" href="/tags/IDENTITY-column/">IDENTITY column</a> <a class="tag tag--primary tag--small t-link" href="/tags/MySQL/">MySQL</a> <a class="tag tag--primary tag--small t-link" href="/tags/Performance/">Performance</a> <a class="tag tag--primary tag--small t-link" href="/tags/Sequence/">Sequence</a> <a class="tag tag--primary tag--small t-link" href="/tags/Spring-Data/">Spring Data</a> <a class="tag tag--primary tag--small t-link" href="/tags/Spring-Data-JDBC/">Spring Data JDBC</a> <a class="tag tag--primary tag--small t-link" href="/tags/Spring-Data-JPA/">Spring Data JPA</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2020/04/09/Java-Native-Memory-Tracking/"  data-tooltip="Java Native Memory Tracking">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/12/25/GET이냐-POST냐-그것이-문제로다/" data-tooltip="GET이냐 POST냐 그것이 문제로다">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 HomoEfficio. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2020/04/09/Java-Native-Memory-Tracking/"  data-tooltip="Java Native Memory Tracking">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/12/25/GET이냐-POST냐-그것이-문제로다/" data-tooltip="GET이냐 POST냐 그것이 문제로다">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>
                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="1">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://homoefficio.github.io/2020/01/25/Spring-Data에서-Batch-Insert-최적화/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/30f0244ab86396288cdb62c3591c0c30?s=110"/>
        
            <h4 id="about-card-name">HomoEfficio</h4>
        
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Seoul, Korea.
            </h5>
        
    </div>
</div>
        <div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'hanmomhanda';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>



</html>
